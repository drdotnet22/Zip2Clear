@page "/invoices/{InvoiceId}"

@using Zip2Clear.Data
@using Microsoft.EntityFrameworkCore

@inject MyDbContext dbContext
@inject NavigationManager NavigationManager

<CascadingValue Value="invoice" >
    <_1Invoice Close="CloseInvoice"/>
</CascadingValue>

@code {
    [Parameter]
    public string? InvoiceId { get; set; }

    
    private List<Invoice> Invoices;

    public Invoice invoice { get; set; } = new Invoice();

    protected override async Task OnInitializedAsync()
    {
        if (InvoiceId == "new")
        {
            invoice.InvoiceId = Guid.NewGuid();
            invoice.Date = DateTime.Now;
        }
        else
        {
            await LoadInvoiceAsync();
        }

        await base.OnInitializedAsync();
    }

    
    private async Task LoadInvoiceAsync()
    {
        Invoices = await dbContext.Invoice.Include(i => i.Vendor).ToListAsync();
        invoice = Invoices.FirstOrDefault(i => i.InvoiceId.ToString() == InvoiceId);
    }

    public void CloseInvoice(string action)
    {
        if (action == "CloseInvoice")
        {
            NavigationManager.NavigateTo("/invoices");
        }
    }
}
